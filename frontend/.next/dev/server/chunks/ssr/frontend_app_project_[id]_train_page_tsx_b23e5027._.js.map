{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/app/project/%5Bid%5D/train/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useEffect, useRef, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useParams } from \"next/navigation\";\r\n\r\nexport default function TrainingPage() {\r\n  const params = useParams();\r\n  const project_id = params.id as string;\r\n\r\n  const [createDsProgress, setCreateDsProgress] = useState(0);\r\n  const [trainProgress, setTrainProgress] = useState(0);\r\n  const [isCreatingDs, setIsCreatingDs] = useState(false);\r\n  const [isTraining, setIsTraining] = useState(false);\r\n\r\n  // useRef 儲存 interval ID\r\n  const createDsIntervalRef = useRef<NodeJS.Timeout | null>(null);\r\n  const trainIntervalRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  // 清除函數\r\n  const clearCreateDsPolling = () => {\r\n    if (createDsIntervalRef.current) {\r\n      clearInterval(createDsIntervalRef.current);\r\n      createDsIntervalRef.current = null;\r\n    }\r\n  };\r\n\r\n  const clearTrainPolling = () => {\r\n    if (trainIntervalRef.current) {\r\n      clearInterval(trainIntervalRef.current);\r\n      trainIntervalRef.current = null;\r\n    }\r\n  };\r\n\r\n  // 建立資料集\r\n  const handleCreateDs = async () => {\r\n    if (isCreatingDs) return; // 防止重複點擊\r\n\r\n    setIsCreatingDs(true);\r\n    setCreateDsProgress(0);\r\n\r\n    try {\r\n      const res = await fetch(\"/create_dataset\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ project_id }),\r\n      });\r\n\r\n      if (!res.ok) throw new Error(\"建立資料集失敗\");\r\n\r\n      // 開始輪詢進度\r\n      createDsIntervalRef.current = setInterval(async () => {\r\n        try {\r\n          const progRes = await fetch(\"/get_auto_annotation_progress\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({ project_id }),\r\n          });\r\n\r\n          if (!progRes.ok) throw new Error(\"取得進度失敗\");\r\n\r\n          const data = await progRes.json();\r\n          setCreateDsProgress(data.progress);\r\n\r\n          // 進度完成 → 停止輪詢\r\n          if (data.progress >= 100) {\r\n            clearCreateDsPolling();\r\n            setIsCreatingDs(false);\r\n          }\r\n        } catch (err) {\r\n          console.error(\"輪詢錯誤:\", err);\r\n          // 可選：顯示錯誤訊息\r\n        }\r\n      }, 1000);\r\n    } catch (err) {\r\n      console.error(\"建立資料集失敗:\", err);\r\n      alert(\"無法建立資料集\");\r\n      setIsCreatingDs(false);\r\n    }\r\n  };\r\n\r\n  // 訓練模型\r\n  const handleTraining = async () => {\r\n    if (isTraining) return;\r\n\r\n    setIsTraining(true);\r\n    setTrainProgress(0);\r\n\r\n    try {\r\n      const res = await fetch(\"/train\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ project_id }),\r\n      });\r\n\r\n      if (!res.ok) throw new Error(\"啟動訓練失敗\");\r\n\r\n      trainIntervalRef.current = setInterval(async () => {\r\n        try {\r\n          const progRes = await fetch(\"/get_training_progress\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({ project_id }),\r\n          });\r\n\r\n          if (!progRes.ok) throw new Error(\"取得訓練進度失敗\");\r\n\r\n          const data = await progRes.json();\r\n          setTrainProgress(data.progress);\r\n\r\n          if (data.progress >= 100) {\r\n            clearTrainPolling();\r\n            setIsTraining(false);\r\n          }\r\n        } catch (err) {\r\n          console.error(\"訓練輪詢錯誤:\", err);\r\n        }\r\n      }, 1000);\r\n    } catch (err) {\r\n      console.error(\"訓練啟動失敗:\", err);\r\n      alert(\"無法開始訓練\");\r\n      setIsTraining(false);\r\n    }\r\n  };\r\n\r\n  // 元件卸載時清除所有 interval\r\n  useEffect(() => {\r\n    return () => {\r\n      clearCreateDsPolling();\r\n      clearTrainPolling();\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"container mx-auto p-6\">\r\n      <h1 className=\"text-2xl font-bold mb-4\">Training Page</h1>\r\n      <p>Project ID: {project_id}</p>\r\n\r\n      <button\r\n        onClick={handleCreateDs}\r\n        disabled={isCreatingDs}\r\n        className=\"btn-primary\"\r\n      >\r\n        {isCreatingDs ? \"建立中...\" : \"Create a dataset\"}\r\n      </button>\r\n      <progress value={createDsProgress} max=\"100\" className=\"w-full mt-4\" />\r\n\r\n      <button\r\n        onClick={handleTraining}\r\n        disabled={isTraining}\r\n        className=\"btn-primary\"\r\n      >\r\n        {isTraining ? \"訓練中...\" : \"Train model\"}\r\n      </button>\r\n      <progress value={trainProgress} max=\"100\" className=\"w-full mt-4\" />\r\n\r\n      <div className=\"mt-4\">\r\n        <Link\r\n          href={`/project/${project_id}/upload`}\r\n          className=\"text-blue-600 hover:underline\"\r\n        >\r\n          ← Back to Upload\r\n        </Link>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}