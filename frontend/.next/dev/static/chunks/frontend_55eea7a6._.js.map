{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/lib/api-config.ts"],"sourcesContent":["// API Configuration utility\r\nimport { log } from './logger';\r\n\r\n// Default API configuration\r\nconst DEFAULT_API_CONFIG = {\r\n  baseUrl: 'http://localhost:8888',\r\n  timeout: 10000,\r\n  retries: 3\r\n};\r\n\r\n// Fallback URLs to try if the primary URL fails\r\nconst FALLBACK_URLS = [\r\n  'http://localhost:8888',\r\n  'http://127.0.0.1:8888',\r\n  'http://host.docker.internal:8888',\r\n  'http://backend:8888'\r\n];\r\n\r\n// Cache for working URL\r\nlet cachedWorkingUrl: string | null = null;\r\n\r\n/**\r\n * Get the working API URL\r\n */\r\nexport async function getApiUrl(): Promise<string> {\r\n  // Return cached URL if available\r\n  if (cachedWorkingUrl) {\r\n    return cachedWorkingUrl;\r\n  }\r\n\r\n  // Try environment variable first\r\n  const envUrl = process.env.NEXT_PUBLIC_API_URL;\r\n  if (envUrl) {\r\n    log.info('API_CONFIG', 'Using environment API URL', { url: envUrl });\r\n    if (await testUrl(envUrl)) {\r\n      cachedWorkingUrl = envUrl;\r\n      return envUrl;\r\n    }\r\n  }\r\n\r\n  // Try fallback URLs\r\n  for (const url of FALLBACK_URLS) {\r\n    log.info('API_CONFIG', 'Testing fallback URL', { url });\r\n    if (await testUrl(url)) {\r\n      cachedWorkingUrl = url;\r\n      log.info('API_CONFIG', 'Found working URL', { url });\r\n      return url;\r\n    }\r\n  }\r\n\r\n  // If all URLs fail, return the default\r\n  log.error('API_CONFIG', 'All API URLs failed, using default', { defaultUrl: DEFAULT_API_CONFIG.baseUrl });\r\n  return DEFAULT_API_CONFIG.baseUrl;\r\n}\r\n\r\n/**\r\n * Test if a URL is reachable\r\n */\r\nasync function testUrl(url: string): Promise<boolean> {\r\n  try {\r\n    const response = await fetch(`${url}/health`, {\r\n      method: 'GET',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      signal: AbortSignal.timeout(5000)\r\n    });\r\n    \r\n    return response.ok;\r\n  } catch (error) {\r\n    log.debug('API_CONFIG', 'URL test failed', { url, error: error instanceof Error ? error.message : String(error) });\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Make an API request with automatic URL resolution\r\n */\r\nexport async function apiRequest(endpoint: string, options: RequestInit = {}): Promise<Response> {\r\n  const baseUrl = await getApiUrl();\r\n  const url = `${baseUrl}${endpoint}`;\r\n  \r\n  log.debug('API_REQUEST', 'Making API request', { url, method: options.method || 'GET' });\r\n  \r\n  const response = await fetch(url, {\r\n    ...options,\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      ...options.headers\r\n    }     \r\n  });\r\n  \r\n  return response;\r\n}\r\n\r\n/**\r\n * Clear the cached URL (useful for testing or when backend restarts)\r\n */\r\nexport function clearApiUrlCache(): void {\r\n  cachedWorkingUrl = null;\r\n  log.info('API_CONFIG', 'API URL cache cleared');\r\n}\r\n"],"names":[],"mappings":"AAAA,4BAA4B;;;;;;;;;AA+BX;AA9BjB;;AAEA,4BAA4B;AAC5B,MAAM,qBAAqB;IACzB,SAAS;IACT,SAAS;IACT,SAAS;AACX;AAEA,gDAAgD;AAChD,MAAM,gBAAgB;IACpB;IACA;IACA;IACA;CACD;AAED,wBAAwB;AACxB,IAAI,mBAAkC;AAK/B,eAAe;IACpB,iCAAiC;IACjC,IAAI,kBAAkB;QACpB,OAAO;IACT;IAEA,iCAAiC;IACjC,MAAM,SAAS,uLAAO,CAAC,GAAG,CAAC,mBAAmB;IAC9C,IAAI,QAAQ;QACV,mIAAG,CAAC,IAAI,CAAC,cAAc,6BAA6B;YAAE,KAAK;QAAO;QAClE,IAAI,MAAM,QAAQ,SAAS;YACzB,mBAAmB;YACnB,OAAO;QACT;IACF;IAEA,oBAAoB;IACpB,KAAK,MAAM,OAAO,cAAe;QAC/B,mIAAG,CAAC,IAAI,CAAC,cAAc,wBAAwB;YAAE;QAAI;QACrD,IAAI,MAAM,QAAQ,MAAM;YACtB,mBAAmB;YACnB,mIAAG,CAAC,IAAI,CAAC,cAAc,qBAAqB;gBAAE;YAAI;YAClD,OAAO;QACT;IACF;IAEA,uCAAuC;IACvC,mIAAG,CAAC,KAAK,CAAC,cAAc,sCAAsC;QAAE,YAAY,mBAAmB,OAAO;IAAC;IACvG,OAAO,mBAAmB,OAAO;AACnC;AAEA;;CAEC,GACD,eAAe,QAAQ,GAAW;IAChC,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,GAAG,IAAI,OAAO,CAAC,EAAE;YAC5C,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,QAAQ,YAAY,OAAO,CAAC;QAC9B;QAEA,OAAO,SAAS,EAAE;IACpB,EAAE,OAAO,OAAO;QACd,mIAAG,CAAC,KAAK,CAAC,cAAc,mBAAmB;YAAE;YAAK,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;QAAO;QAChH,OAAO;IACT;AACF;AAKO,eAAe,WAAW,QAAgB,EAAE,UAAuB,CAAC,CAAC;IAC1E,MAAM,UAAU,MAAM;IACtB,MAAM,MAAM,GAAG,UAAU,UAAU;IAEnC,mIAAG,CAAC,KAAK,CAAC,eAAe,sBAAsB;QAAE;QAAK,QAAQ,QAAQ,MAAM,IAAI;IAAM;IAEtF,MAAM,WAAW,MAAM,MAAM,KAAK;QAChC,GAAG,OAAO;QACV,SAAS;YACP,gBAAgB;YAChB,GAAG,QAAQ,OAAO;QACpB;IACF;IAEA,OAAO;AACT;AAKO,SAAS;IACd,mBAAmB;IACnB,mIAAG,CAAC,IAAI,CAAC,cAAc;AACzB","debugId":null}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/app/dashboard/get_project_info.ts"],"sourcesContent":["import { ApiService } from '../../lib/api';\r\nimport { apiRequest } from '../../lib/api-config';\r\nimport type { ProjectInfo } from '../../lib/api';\r\nimport { log } from '../../lib/logger';\r\n\r\nexport type StatusType =\r\n  | \"No uploads\"\r\n  | \"Annotating\"\r\n  | \"Annotation Completed\"\r\n  | \"Training\"\r\n  | \"Finish training\"\r\n  | \"Complete\";\r\n\r\nexport { ProjectInfo };\r\n\r\nexport async function getProjectsInfo(userId: number): Promise<ProjectInfo[]> {\r\n  try {\r\n    log.info('PROJECT_INFO', 'Fetching projects for user', { userId });\r\n    \r\n    // Use the new API configuration system\r\n    const response = await apiRequest('/get_projects_info', {\r\n      method: 'POST',\r\n      body: JSON.stringify({ userID: userId.toString() })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      log.warn('PROJECT_INFO', 'API returned error status', { \r\n        status: response.status,\r\n        userId \r\n      });\r\n      return [];\r\n    }\r\n\r\n    const data = await response.json();\r\n    log.info('PROJECT_INFO', 'Received projects data', { \r\n      ownedProjects: data['owned projects']?.length || 0,\r\n      sharedProjects: data['shared projects']?.length || 0,\r\n      userId \r\n    });\r\n\r\n    // Transform the response to match our ProjectInfo interface\r\n    const ownedProjects = data['owned projects'] || [];\r\n    const sharedProjects = data['shared projects'] || [];\r\n    \r\n    const allProjects = [...ownedProjects, ...sharedProjects];\r\n  // get_project_info.ts\r\n    const projectDetails = allProjects.map((project: any) => ({\r\n      id: project.project_id || project.id,\r\n      name: project[\"project name\"] || project.name || 'Unknown Project',  // ← 必須用 [\"project name\"]\r\n      videoCount: project[\"video count\"] || project.videoCount || 0,       // ← 必須用 [\"video count\"]\r\n      status: project.status || 'Unknown',\r\n      isOwned: project.isOwned === true\r\n}));\r\n\r\n    log.info('PROJECT_INFO', 'Successfully processed projects', { \r\n      totalProjects: projectDetails.length,\r\n      userId \r\n    });\r\n\r\n    return projectDetails;\r\n  } catch (error) {\r\n    log.error('PROJECT_INFO', 'Error fetching projects', { \r\n      error: error instanceof Error ? error.message : String(error),\r\n      userId \r\n    });\r\n    return [];\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AACA;AAEA;;;AAYO,eAAe,gBAAgB,MAAc;IAClD,IAAI;QACF,mIAAG,CAAC,IAAI,CAAC,gBAAgB,8BAA8B;YAAE;QAAO;QAEhE,uCAAuC;QACvC,MAAM,WAAW,MAAM,IAAA,iJAAU,EAAC,sBAAsB;YACtD,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;gBAAE,QAAQ,OAAO,QAAQ;YAAG;QACnD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,mIAAG,CAAC,IAAI,CAAC,gBAAgB,6BAA6B;gBACpD,QAAQ,SAAS,MAAM;gBACvB;YACF;YACA,OAAO,EAAE;QACX;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,mIAAG,CAAC,IAAI,CAAC,gBAAgB,0BAA0B;YACjD,eAAe,IAAI,CAAC,iBAAiB,EAAE,UAAU;YACjD,gBAAgB,IAAI,CAAC,kBAAkB,EAAE,UAAU;YACnD;QACF;QAEA,4DAA4D;QAC5D,MAAM,gBAAgB,IAAI,CAAC,iBAAiB,IAAI,EAAE;QAClD,MAAM,iBAAiB,IAAI,CAAC,kBAAkB,IAAI,EAAE;QAEpD,MAAM,cAAc;eAAI;eAAkB;SAAe;QAC3D,sBAAsB;QACpB,MAAM,iBAAiB,YAAY,GAAG,CAAC,CAAC,UAAiB,CAAC;gBACxD,IAAI,QAAQ,UAAU,IAAI,QAAQ,EAAE;gBACpC,MAAM,OAAO,CAAC,eAAe,IAAI,QAAQ,IAAI,IAAI;gBACjD,YAAY,OAAO,CAAC,cAAc,IAAI,QAAQ,UAAU,IAAI;gBAC5D,QAAQ,QAAQ,MAAM,IAAI;gBAC1B,SAAS,QAAQ,OAAO,KAAK;YACnC,CAAC;QAEG,mIAAG,CAAC,IAAI,CAAC,gBAAgB,mCAAmC;YAC1D,eAAe,eAAe,MAAM;YACpC;QACF;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,mIAAG,CAAC,KAAK,CAAC,gBAAgB,2BAA2B;YACnD,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;YACvD;QACF;QACA,OAAO,EAAE;IACX;AACF","debugId":null}},
    {"offset": {"line": 181, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/app/dashboard/get_project_details.ts"],"sourcesContent":["// get_project_details.ts\r\nimport { apiRequest } from '../../lib/api-config';\r\nimport { log } from '../../lib/logger';\r\n\r\n// **後端回傳的精確 Type**（**為什麼要有？** 編輯器自動提示 + 防錯）\r\nexport interface ProjectDetails {\r\n  \"project name\": string;\r\n  \"project type\": string;\r\n  \"video count\": number;\r\n  \"status\": string;\r\n}\r\n\r\nexport async function getProjectDetails(projectId: number): Promise<ProjectDetails | null> {\r\n  try {\r\n    log.info('PROJECT_DETAILS', 'Fetching details for project', { projectId });\r\n    \r\n    // **為什麼用 POST + JSON？** 與 `get_projects_info` **完全一致**，後端期待\r\n    const response = await apiRequest('/get_project_details', {\r\n      method: 'POST',\r\n      body: JSON.stringify({ project_id: projectId })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      log.warn('PROJECT_DETAILS', 'API returned error status', {\r\n        status: response.status,\r\n        projectId\r\n      });\r\n      return null;  // **為什麼 return null？** UI 可顯示「載入失敗」，不崩潰\r\n    }\r\n\r\n    const data = await response.json();\r\n    return {\r\n      \"project name\": data[\"project name\"],\r\n      \"project type\": data[\"project type\"],\r\n      \"video count\": data[\"video count\"],\r\n      \"status\": data[\"status\"]\r\n    };\r\n  } catch (error) {\r\n    log.error('PROJECT_DETAILS', 'Error fetching details', { error, projectId });\r\n    return null;\r\n  }\r\n}"],"names":[],"mappings":"AAAA,yBAAyB;;;;;AACzB;AACA;;;AAUO,eAAe,kBAAkB,SAAiB;IACvD,IAAI;QACF,mIAAG,CAAC,IAAI,CAAC,mBAAmB,gCAAgC;YAAE;QAAU;QAExE,4DAA4D;QAC5D,MAAM,WAAW,MAAM,IAAA,iJAAU,EAAC,wBAAwB;YACxD,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;gBAAE,YAAY;YAAU;QAC/C;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,mIAAG,CAAC,IAAI,CAAC,mBAAmB,6BAA6B;gBACvD,QAAQ,SAAS,MAAM;gBACvB;YACF;YACA,OAAO,MAAO,wCAAwC;QACxD;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,OAAO;YACL,gBAAgB,IAAI,CAAC,eAAe;YACpC,gBAAgB,IAAI,CAAC,eAAe;YACpC,eAAe,IAAI,CAAC,cAAc;YAClC,UAAU,IAAI,CAAC,SAAS;QAC1B;IACF,EAAE,OAAO,OAAO;QACd,mIAAG,CAAC,KAAK,CAAC,mBAAmB,0BAA0B;YAAE;YAAO;QAAU;QAC1E,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 231, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/app/dashboard/NewProjectForm.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useState } from \"react\";\r\nimport { X, Plus, Save, FolderOpen } from \"lucide-react\";\r\nimport { ApiService, ProjectInfo } from \"../../lib/api\";\r\nimport { apiRequest } from \"../../lib/api-config\";\r\nimport { log } from \"../../lib/logger\";\r\n\r\ninterface Project {\r\n  id: number;\r\n  name: string;\r\n  videoCount: number;\r\n  status?: string;\r\n}\r\n\r\ninterface NewProjectFormProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onProjectCreated: (project: Project) => void;\r\n  userId: number;\r\n}\r\n\r\nexport default function NewProjectForm({ isOpen, onClose, onProjectCreated, userId }: NewProjectFormProps) {\r\n  const [formData, setFormData] = useState({\r\n    name: \"\",\r\n    projectType: \"object_detection\"\r\n  });\r\n\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n\r\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\r\n    const { name, value } = e.target;\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      [name]: value\r\n    }));\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setIsSubmitting(true);\r\n\r\n    try {\r\n      log.info('NEW_PROJECT', 'Creating new project', { \r\n        userId, \r\n        projectName: formData.name, \r\n        projectType: formData.projectType \r\n      });\r\n\r\n      // Use the new API configuration system\r\n      const response = await apiRequest('/create_project', {\r\n        method: 'POST',\r\n        body: JSON.stringify({\r\n          userID: userId.toString(),\r\n          project_name: formData.name,\r\n          project_type: formData.projectType,\r\n        })\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      log.info('NEW_PROJECT', 'Project created successfully', { \r\n        projectId: data.project_id,\r\n        projectName: formData.name \r\n      });\r\n      \r\n      if (data.success) {\r\n        const newProject: Project = {\r\n          id: data.project_id,\r\n          name: formData.name,\r\n          videoCount: 0,\r\n          status: \"Not started\"\r\n        };\r\n        \r\n        onProjectCreated(newProject);\r\n        \r\n        // Reset form\r\n        setFormData({\r\n          name: \"\",\r\n          projectType: \"object_detection\"\r\n        });\r\n        \r\n        onClose();\r\n      } else {\r\n        console.error(\"Failed to create project:\", response);\r\n        alert(\"Failed to create project. Please try again.\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error creating project:\", error);\r\n      alert(\"Error creating project. Please try again.\");\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"modal-overlay\">\r\n      <div className=\"modal-content project-form-modal\">\r\n        <div className=\"modal-header\">\r\n          <div className=\"modal-title\">\r\n            <FolderOpen className=\"modal-icon\" />\r\n            <h2>Create New Project</h2>\r\n          </div>\r\n          <button \r\n            className=\"modal-close\" \r\n            onClick={onClose}\r\n            disabled={isSubmitting}\r\n          >\r\n            <X />\r\n          </button>\r\n        </div>\r\n\r\n        <form onSubmit={handleSubmit} className=\"project-form\">\r\n          <div className=\"form-group\">\r\n            <label htmlFor=\"name\" className=\"form-label\">\r\n              Project Name *\r\n            </label>\r\n            <input\r\n              type=\"text\"\r\n              id=\"name\"\r\n              name=\"name\"\r\n              value={formData.name}\r\n              onChange={handleInputChange}\r\n              placeholder=\"Enter project name\"\r\n              className=\"form-input\"\r\n              required\r\n            />\r\n          </div>\r\n\r\n          <div className=\"form-group\">\r\n            <label htmlFor=\"projectType\" className=\"form-label\">\r\n              Project Type *\r\n            </label>\r\n            <select\r\n              id=\"projectType\"\r\n              name=\"projectType\"\r\n              value={formData.projectType}\r\n              onChange={handleInputChange}\r\n              className=\"form-input\"\r\n              required\r\n            >\r\n              <option value=\"object_detection\">Object Detection</option>\r\n              <option value=\"classification\">Classification</option>\r\n              <option value=\"segmentation\">Segmentation</option>\r\n            </select>\r\n          </div>\r\n\r\n          <div className=\"form-actions\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onClose}\r\n              className=\"btn-secondary\"\r\n              disabled={isSubmitting}\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"submit\"\r\n              className=\"btn-primary\"\r\n              disabled={isSubmitting || !formData.name}\r\n            >\r\n              {isSubmitting ? (\r\n                <>\r\n                  <div className=\"spinner\"></div>\r\n                  Creating...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Save className=\"btn-icon\" />\r\n                  Create Project\r\n                </>\r\n              )}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 539, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/lib/project-cache.ts"],"sourcesContent":["// Project cache management utility\r\nimport { ProjectInfo } from './api';\r\nimport { log } from './logger';\r\n\r\nexport interface CachedProject {\r\n  project_id: number;\r\n  project_name: string;\r\n  project_type: string;\r\n  video_count: number;\r\n  status: string;\r\n  ownership: 'owned' | 'shared';\r\n}\r\n\r\nexport class ProjectCache {\r\n  private static CACHE_KEY = 'userProjects';\r\n  private static CACHE_EXPIRY_KEY = 'userProjectsExpiry';\r\n  private static CACHE_DURATION = 5 * 60 * 1000; // 5 minutes\r\n\r\n  /**\r\n   * Store projects in cache\r\n   */\r\n  static async setProjects(projects: CachedProject[]): Promise<void> {\r\n    if (typeof window === 'undefined' || !window.cookieStore) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const expiryTime = Date.now() + this.CACHE_DURATION;\r\n      \r\n      await window.cookieStore.set(this.CACHE_KEY, JSON.stringify(projects));\r\n      await window.cookieStore.set(this.CACHE_EXPIRY_KEY, expiryTime.toString());\r\n      \r\n      log.info('PROJECT_CACHE', 'Projects cached successfully', { \r\n        projectCount: projects.length,\r\n        expiryTime: new Date(expiryTime).toISOString()\r\n      });\r\n    } catch (error) {\r\n      log.error('PROJECT_CACHE', 'Error caching projects', { error });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get projects from cache\r\n   */\r\n  static async getProjects(): Promise<CachedProject[] | null> {\r\n    if (typeof window === 'undefined' || !window.cookieStore) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      // Check if cache is expired\r\n      const expiryCookie = await window.cookieStore.get(this.CACHE_EXPIRY_KEY);\r\n      if (expiryCookie?.value) {\r\n        const expiryTime = parseInt(expiryCookie.value);\r\n        if (Date.now() > expiryTime) {\r\n          log.info('PROJECT_CACHE', 'Cache expired, clearing');\r\n          await this.clearCache();\r\n          return null;\r\n        }\r\n      }\r\n\r\n      // Get cached projects\r\n      const projectsCookie = await window.cookieStore.get(this.CACHE_KEY);\r\n      if (projectsCookie?.value) {\r\n        const projects = JSON.parse(projectsCookie.value);\r\n        log.info('PROJECT_CACHE', 'Projects retrieved from cache', { \r\n          projectCount: projects.length \r\n        });\r\n        return projects;\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      log.error('PROJECT_CACHE', 'Error reading cached projects', { error });\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert cached projects to ProjectInfo format\r\n   */\r\n  static convertToProjectInfo(cachedProjects: CachedProject[]): ProjectInfo[] {\r\n    return cachedProjects.map(project => ({\r\n      id: project.project_id,\r\n      name: project.project_name,\r\n      videoCount: project.video_count || 0,\r\n      status: project.status || 'Active',\r\n      isOwned: project.ownership === 'owned'\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Clear project cache\r\n   */\r\n  static async clearCache(): Promise<void> {\r\n    if (typeof window === 'undefined' || !window.cookieStore) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await window.cookieStore.delete(this.CACHE_KEY);\r\n      await window.cookieStore.delete(this.CACHE_EXPIRY_KEY);\r\n      log.info('PROJECT_CACHE', 'Cache cleared successfully');\r\n    } catch (error) {\r\n      log.error('PROJECT_CACHE', 'Error clearing cache', { error });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if cache exists and is valid\r\n   */\r\n  static async hasValidCache(): Promise<boolean> {\r\n    const projects = await this.getProjects();\r\n    return projects !== null && projects.length >= 0;\r\n  }\r\n\r\n  /**\r\n   * Update a specific project in cache\r\n   */\r\n  static async updateProject(projectId: number, updates: Partial<CachedProject>): Promise<void> {\r\n    const projects = await this.getProjects();\r\n    if (!projects) return;\r\n\r\n    const projectIndex = projects.findIndex(p => p.project_id === projectId);\r\n    if (projectIndex !== -1) {\r\n      projects[projectIndex] = { ...projects[projectIndex], ...updates };\r\n      await this.setProjects(projects);\r\n      log.info('PROJECT_CACHE', 'Project updated in cache', { projectId, updates });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a new project to cache\r\n   */\r\n  static async addProject(project: CachedProject): Promise<void> {\r\n    const projects = await this.getProjects();\r\n    if (!projects) {\r\n      await this.setProjects([project]);\r\n    } else {\r\n      projects.push(project);\r\n      await this.setProjects(projects);\r\n    }\r\n    log.info('PROJECT_CACHE', 'Project added to cache', { projectId: project.project_id });\r\n  }\r\n\r\n  /**\r\n   * Remove a project from cache\r\n   */\r\n  static async removeProject(projectId: number): Promise<void> {\r\n    const projects = await this.getProjects();\r\n    if (!projects) return;\r\n\r\n    const filteredProjects = projects.filter(p => p.project_id !== projectId);\r\n    await this.setProjects(filteredProjects);\r\n    log.info('PROJECT_CACHE', 'Project removed from cache', { projectId });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 690, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/app/dashboard/ProjectShareModal.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useState, useEffect, useRef, useCallback } from \"react\";\r\nimport { X, Share2, UserPlus, Trash2, Eye, Edit, Users } from \"lucide-react\";\r\nimport { apiRequest } from \"../../lib/api-config\";\r\nimport { log } from \"../../lib/logger\";\r\n\r\ninterface ProjectShareModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  projectId: number;\r\n  projectName: string;\r\n  onShareSuccess?: () => void;\r\n  onNameChange?: (newName: string) => void;\r\n}\r\n\r\ninterface ShareInfo {\r\n  id: number;\r\n  username: string;\r\n  permissions: string;\r\n  shared_at: string;\r\n  user_id: number;\r\n}\r\n\r\nexport default function ProjectShareModal({ \r\n  isOpen, \r\n  onClose, \r\n  projectId, \r\n  projectName,\r\n  onShareSuccess,\r\n  onNameChange\r\n}: ProjectShareModalProps) {\r\n  const [username, setUsername] = useState(\"\");\r\n  const [permissions, setPermissions] = useState<\"read\" | \"write\">(\"read\");\r\n  const [isSharing, setIsSharing] = useState(false);\r\n  const [shares, setShares] = useState<ShareInfo[]>([]);\r\n  const [isLoadingShares, setIsLoadingShares] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState<string | null>(null);\r\n\r\n  // === 修改名稱狀態 ===\r\n  const [isEditingName, setIsEditingName] = useState(false);\r\n  const [editingName, setEditingName] = useState(projectName);\r\n  const [isSavingName, setIsSavingName] = useState(false);\r\n  const nameInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // === 載入分享名單 ===\r\n  const loadShares = useCallback(async () => {\r\n    setIsLoadingShares(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const response = await apiRequest('/get_project_shares', {\r\n        method: 'POST',\r\n        body: JSON.stringify({ project_id: projectId })\r\n      });\r\n\r\n      if (!response.ok) throw new Error(`HTTP ${response.status}`);\r\n      const data = await response.json();\r\n\r\n      if (data.success) {\r\n        setShares(data.shares || []);\r\n        log.info('PROJECT_SHARE', 'Shares loaded', { projectId, shareCount: data.shares?.length });\r\n      } else {\r\n        throw new Error(data.message || 'Failed to load shares');\r\n      }\r\n    } catch (err) {\r\n      const msg = err instanceof Error ? err.message : 'Unknown error';\r\n      log.error('PROJECT_SHARE', 'Load shares failed', { projectId, error: msg });\r\n      setError(`載入失敗: ${msg}`);\r\n    } finally {\r\n      setIsLoadingShares(false);\r\n    }\r\n  }, [projectId]);\r\n\r\n  // === 分享專案 ===\r\n  const handleShare = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!username.trim()) { setError(\"請輸入使用者名稱\"); return; }\r\n\r\n    setIsSharing(true); setError(null); setSuccess(null);\r\n\r\n    try {\r\n      const response = await apiRequest('/share_project', {\r\n        method: 'POST',\r\n        body: JSON.stringify({\r\n          project_id: projectId,\r\n          shared_with_username: username.trim(),\r\n          permissions\r\n        })\r\n      });\r\n\r\n      if (!response.ok) throw new Error(`HTTP ${response.status}`);\r\n      const data = await response.json();\r\n\r\n      if (data.success) {\r\n        setSuccess(data.message);\r\n        setUsername(\"\"); setPermissions(\"read\");\r\n        await loadShares();\r\n        onShareSuccess?.();\r\n        log.info('PROJECT_SHARE', 'Shared successfully', { projectId, username: username.trim() });\r\n      } else {\r\n        throw new Error(data.message || '分享失敗');\r\n      }\r\n    } catch (err) {\r\n      const msg = err instanceof Error ? err.message : 'Unknown error';\r\n      log.error('PROJECT_SHARE', 'Share failed', { projectId, error: msg });\r\n      setError(msg);\r\n    } finally {\r\n      setIsSharing(false);\r\n    }\r\n  };\r\n\r\n  // === 取消分享 ===\r\n  const handleUnshare = async (username: string) => {\r\n    if (!confirm(`確定要取消與 ${username} 的分享？`)) return;\r\n\r\n    try {\r\n      const response = await apiRequest('/unshare_project', {\r\n        method: 'POST',\r\n        body: JSON.stringify({\r\n          project_id: projectId,\r\n          shared_with_username: username\r\n        })\r\n      });\r\n\r\n      if (!response.ok) throw new Error(`HTTP ${response.status}`);\r\n      const data = await response.json();\r\n\r\n      if (data.success) {\r\n        setSuccess(data.message);\r\n        await loadShares();\r\n        log.info('PROJECT_SHARE', 'Unshared', { projectId, username });\r\n      } else {\r\n        throw new Error(data.message || '取消失敗');\r\n      }\r\n    } catch (err) {\r\n      const msg = err instanceof Error ? err.message : 'Unknown error';\r\n      log.error('PROJECT_SHARE', 'Unshare failed', { projectId, username, error: msg });\r\n      setError(msg);\r\n    }\r\n  };\r\n\r\n// === 修改專案名稱（完全符合後端簽名）===\r\nconst saveProjectName = async () => {\r\n  const trimmedName = editingName.trim();\r\n  if (!trimmedName || trimmedName === projectName) {\r\n    setIsEditingName(false);\r\n    return;\r\n  }\r\n\r\n  setIsSavingName(true);\r\n  setError(null);\r\n\r\n  try {\r\n    // 建立 query string：?new_name=xxx\r\n    const url = new URL('/change_project_name', window.location.origin);\r\n    url.searchParams.append('new_name', trimmedName);\r\n\r\n    // Body 只傳 project_id\r\n    const response = await apiRequest(url.pathname + url.search, {\r\n      method: 'POST',\r\n      body: JSON.stringify({\r\n        project_id: projectId  // 必須是 project_id\r\n      })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      let errorMsg = `HTTP ${response.status}`;\r\n      try {\r\n        const errData = await response.json();\r\n        errorMsg = errData.message || errData.error || errorMsg;\r\n      } catch {}\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    const data = await response.json();\r\n    if (!data.success) throw new Error(data.message || '修改失敗');\r\n\r\n    log.info('PROJECT_NAME', 'Renamed successfully', { \r\n      projectId, \r\n      oldName: projectName, \r\n      newName: trimmedName \r\n    });\r\n\r\n    onNameChange?.(trimmedName);\r\n    setSuccess(`已更名為「${trimmedName}」`);\r\n\r\n  } catch (err) {\r\n    const msg = err instanceof Error ? err.message : '未知錯誤';\r\n    log.error('PROJECT_NAME', 'Rename failed', { projectId, error: msg });\r\n    setError(`更名失敗: ${msg}`);\r\n    setEditingName(projectName); // 還原\r\n  } finally {\r\n    setIsSavingName(false);\r\n    setIsEditingName(false);\r\n  }\r\n};\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString('zh-TW', {\r\n      year: 'numeric',\r\n      month: 'short',\r\n      day: 'numeric',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  };\r\n\r\n  // === 當 modal 開啟時載入 ===\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      setEditingName(projectName);\r\n      loadShares();\r\n    }\r\n  }, [isOpen, projectId, projectName, loadShares]);\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n      <div className=\"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between p-6 border-b\">\r\n          <div className=\"flex items-center space-x-2 flex-1\">\r\n            <Share2 className=\"h-6 w-6 text-blue-600\" />\r\n            {isEditingName ? (\r\n              <input\r\n                ref={nameInputRef}\r\n                type=\"text\"\r\n                value={editingName}\r\n                onChange={(e) => setEditingName(e.target.value)}\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'Enter') saveProjectName();\r\n                  if (e.key === 'Escape') {\r\n                    setEditingName(projectName);\r\n                    setIsEditingName(false);\r\n                  }\r\n                }}\r\n                className=\"text-xl font-semibold text-gray-900 bg-transparent border-b-2 border-blue-500 focus:outline-none px-1\"\r\n                disabled={isSavingName}\r\n                autoFocus\r\n              />\r\n            ) : (\r\n              <h2\r\n                className=\"text-xl font-semibold text-gray-900 cursor-pointer hover:text-blue-600 transition-colors\"\r\n                onClick={() => {\r\n                  setIsEditingName(true);\r\n                  setTimeout(() => nameInputRef.current?.focus(), 0);\r\n                }}\r\n                title=\"點擊編輯專案名稱\"\r\n              >\r\n                {projectName}\r\n              </h2>\r\n            )}\r\n            {isSavingName && (\r\n              <div className=\"ml-2 animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600\"></div>\r\n            )}\r\n          </div>\r\n          <button onClick={onClose} className=\"text-gray-400 hover:text-gray-600\">\r\n            <X className=\"h-6 w-6\" />\r\n          </button>\r\n        </div>\r\n\r\n        {/* 編輯按鈕 */}\r\n        {isEditingName && (\r\n          <div className=\"flex gap-2 px-6 pb-4\">\r\n            <button\r\n              onClick={saveProjectName}\r\n              disabled={isSavingName}\r\n              className=\"px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50\"\r\n            >\r\n              {isSavingName ? '儲存中...' : '儲存'}\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                setEditingName(projectName);\r\n                setIsEditingName(false);\r\n              }}\r\n              disabled={isSavingName}\r\n              className=\"px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded hover:bg-gray-400\"\r\n            >\r\n              取消\r\n            </button>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"p-6\">\r\n          <div className=\"mb-4\">\r\n            <p className=\"text-sm text-gray-600\">Project ID: {projectId}</p>\r\n          </div>\r\n\r\n          {/* 分享表單 */}\r\n          <form onSubmit={handleShare} className=\"mb-6\">\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <div className=\"md:col-span-2\">\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">使用者名稱</label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={username}\r\n                  onChange={(e) => setUsername(e.target.value)}\r\n                  placeholder=\"輸入要分享的使用者\"\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                  disabled={isSharing}\r\n                />\r\n              </div>\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">權限</label>\r\n                <select\r\n                  value={permissions}\r\n                  onChange={(e) => setPermissions(e.target.value as \"read\" | \"write\")}\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\r\n                  disabled={isSharing}\r\n                >\r\n                  <option value=\"read\">唯讀</option>\r\n                  <option value=\"write\">讀寫</option>\r\n                </select>\r\n              </div>\r\n            </div>\r\n            <button\r\n              type=\"submit\"\r\n              disabled={isSharing || !username.trim()}\r\n              className=\"mt-4 w-full md:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center space-x-2\"\r\n            >\r\n              {isSharing ? (\r\n                <>分享中...</>\r\n              ) : (\r\n                <><UserPlus className=\"h-4 w-4\" /> 分享專案</>\r\n              )}\r\n            </button>\r\n          </form>\r\n\r\n          {/* 訊息 */}\r\n          {error && <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-600\">{error}</div>}\r\n          {success && <div className=\"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-600\">{success}</div>}\r\n\r\n          {/* 分享名單 */}\r\n          <div>\r\n            <div className=\"flex items-center space-x-2 mb-4\">\r\n              <Users className=\"h-5 w-5 text-gray-600\" />\r\n              <h3 className=\"text-lg font-medium text-gray-900\">已分享 ({shares.length})</h3>\r\n            </div>\r\n\r\n            {isLoadingShares ? (\r\n              <div className=\"flex justify-center py-8\">載入中...</div>\r\n            ) : shares.length === 0 ? (\r\n              <div className=\"text-center py-8 text-gray-500\">尚未分享給任何人</div>\r\n            ) : (\r\n              <div className=\"space-y-3\">\r\n                {shares.map((share) => (\r\n                  <div key={share.id} className=\"flex justify-between items-center p-3 bg-gray-50 rounded-lg\">\r\n                    <div className=\"flex items-center space-x-3\">\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        {share.permissions === 'write' ? <Edit className=\"h-4 w-4 text-green-600\" /> : <Eye className=\"h-4 w-4 text-blue-600\" />}\r\n                        <span className=\"font-medium\">{share.username}</span>\r\n                      </div>\r\n                      <span className={`px-2 py-1 rounded-full text-xs ${share.permissions === 'write' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>\r\n                        {share.permissions === 'write' ? '讀寫' : '唯讀'}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex items-center space-x-3\">\r\n                      <span className=\"text-xs text-gray-500\">{formatDate(share.shared_at)}</span>\r\n                      <button onClick={() => handleUnshare(share.username)} className=\"text-red-600 hover:text-red-800\">\r\n                        <Trash2 className=\"h-4 w-4\" />\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1357, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/app/dashboard/UserProjectsManager.tsx"],"sourcesContent":["\"use client\";\r\nimport React, { useState, useEffect } from \"react\";\r\nimport { RefreshCw, Plus, FolderOpen, Users, Crown, Share2 } from \"lucide-react\";\r\nimport { ProjectInfo } from \"../../lib/api\";\r\nimport { getProjectsInfo } from \"./get_project_info\";\r\nimport { log } from \"../../lib/logger\";\r\nimport { ProjectCache } from \"../../lib/project-cache\";\r\nimport ProjectShareModal from \"./ProjectShareModal\";\r\n\r\ninterface UserProjectsManagerProps {\r\n  userId: number;\r\n  username: string;\r\n  onProjectClick: (projectId: number) => void;\r\n  onCreateProject: () => void;\r\n}\r\n\r\nexport default function UserProjectsManager({\r\n  userId,\r\n  username,\r\n  onProjectClick,\r\n  onCreateProject\r\n}: UserProjectsManagerProps) {\r\n  const [projects, setProjects] = useState<ProjectInfo[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [lastUpdated, setLastUpdated] = useState<Date | null>(null);\r\n  const [shareModalOpen, setShareModalOpen] = useState(false);\r\n  const [selectedProject, setSelectedProject] = useState<ProjectInfo | null>(null);\r\n\r\n  const loadProjects = async () => {\r\n    if (userId <= 0) return;\r\n    setIsLoading(true);\r\n    setError(null);\r\n    try {\r\n      log.info('USER_PROJECTS', 'Loading projects for user', { userId, username });\r\n\r\n      let userProjects: ProjectInfo[] = [];\r\n      const cachedProjects = await ProjectCache.getProjects();\r\n      if (cachedProjects && cachedProjects.length > 0) {\r\n        userProjects = ProjectCache.convertToProjectInfo(cachedProjects);\r\n        log.info('USER_PROJECTS', 'Using cached projects', {\r\n          userId,\r\n          username,\r\n          projectCount: userProjects.length\r\n        });\r\n      } else {\r\n        log.info('USER_PROJECTS', 'No cached projects, fetching from API');\r\n        userProjects = await getProjectsInfo(userId);\r\n\r\n        // === 修正點：正確映射到 ProjectCache 格式 ===\r\n        if (userProjects.length > 0) {\r\n          const projectsToCache = userProjects.map(project => ({\r\n            project_id: project.id,                    // ← 正確\r\n            project_name: project.name,                // ← 正確\r\n            video_count: project.videoCount,   // ← 正確\r\n            project_type: \"object_dectection\",    //hard code now JimmyFix\r\n            status: project.status || 'Active', // ← 防 undefined\r\n            ownership: project.isOwned ? 'owned' : 'shared' as 'owned' | 'shared'\r\n          }));\r\n\r\n          try {\r\n            await ProjectCache.setProjects(projectsToCache);\r\n            log.info('PROJECT_CACHE', 'Projects cached successfully', { count: projectsToCache.length });\r\n          } catch (cacheError) {\r\n            log.warn('PROJECT_CACHE', 'Failed to cache projects', { cacheError });\r\n          }\r\n        }\r\n      }\r\n\r\n      log.info('USER_PROJECTS', 'Projects loaded successfully', {\r\n        userId,\r\n        username,\r\n        projectCount: userProjects.length\r\n      });\r\n      setProjects(userProjects);\r\n      setLastUpdated(new Date());\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      log.error('USER_PROJECTS', 'Error loading projects', {\r\n        userId,\r\n        username,\r\n        error: errorMessage\r\n      });\r\n      setError(`Failed to load projects: ${errorMessage}`);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadProjects();\r\n  }, [userId]);\r\n  \r\n  const handleShareProject = (project: ProjectInfo) => {\r\n    setSelectedProject(project);\r\n    setShareModalOpen(true);\r\n  };\r\n\r\n  const handleShareSuccess = () => {\r\n    loadProjects();\r\n  };\r\n\r\n  const handleCloseShareModal = () => {\r\n    setShareModalOpen(false);\r\n    setSelectedProject(null);\r\n  };\r\n\r\n  const ownedProjects = projects.filter(p => p.isOwned === true);\r\n  const sharedProjects = projects.filter(p => p.isOwned === false);\r\n\r\n  return (\r\n    <div className=\"user-projects-manager\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between mb-6\">\r\n        <div className=\"flex items-center space-x-3\">\r\n          <div className=\"flex items-center space-x-2\">\r\n            <Users className=\"h-6 w-6 text-blue-600\" />\r\n            <h2 className=\"text-xl font-semibold text-gray-900\">\r\n              {username}'s Projects\r\n            </h2>\r\n          </div>\r\n          {lastUpdated && (\r\n            <span className=\"text-sm text-gray-500\">\r\n              Last updated: {lastUpdated.toLocaleTimeString()}\r\n            </span>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Error Message */}\r\n      {error && (\r\n        <div className=\"mb-4 p-4 bg-red-50 border border-red-200 rounded-lg\">\r\n          <p className=\"text-sm text-red-600\">{error}</p>\r\n        </div>\r\n      )}\r\n\r\n      {/* Loading State */}\r\n      {isLoading && (\r\n        <div className=\"flex items-center justify-center py-8\">\r\n          <div className=\"flex items-center space-x-2\">\r\n            <RefreshCw className=\"h-5 w-5 animate-spin text-blue-600\" />\r\n            <span className=\"text-gray-600\">Loading projects...</span>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Projects Grid */}\r\n      {!isLoading && (\r\n        <div className=\"space-y-6\">\r\n          {/* Owned Projects */}\r\n          {ownedProjects.length > 0 && (\r\n            <div>\r\n              <div className=\"flex items-center space-x-2 mb-4\">\r\n                <Crown className=\"h-5 w-5 text-yellow-500\" />\r\n                <h3 className=\"text-lg font-medium text-gray-900\">\r\n                  Owned Projects ({ownedProjects.length})\r\n                </h3>\r\n              </div>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                {ownedProjects.map((project) => (\r\n                  <ProjectCard\r\n                    key={project.id}\r\n                    project={project}\r\n                    onClick={() => onProjectClick(project.id)}\r\n                    onShare={() => handleShareProject(project)}\r\n                    canShare={true}\r\n                  />\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Shared Projects */}\r\n          {sharedProjects.length > 0 && (\r\n            <div>\r\n              <div className=\"flex items-center space-x-2 mb-4\">\r\n                <Users className=\"h-5 w-5 text-green-500\" />\r\n                <h3 className=\"text-lg font-medium text-gray-900\">\r\n                  Shared Projects ({sharedProjects.length})\r\n                </h3>\r\n              </div>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                {sharedProjects.map((project) => (\r\n                  <ProjectCard\r\n                    key={project.id}\r\n                    project={project}\r\n                    onClick={() => onProjectClick(project.id)}\r\n                    canShare={false}\r\n                  />\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* No Projects */}\r\n          {projects.length === 0 && !isLoading && (\r\n            <div className=\"text-center py-12\">\r\n              <FolderOpen className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n                No projects found\r\n              </h3>\r\n              <p className=\"text-gray-600 mb-4\">\r\n                Get started by creating your first project\r\n              </p>\r\n              <button\r\n                onClick={onCreateProject}\r\n                className=\"inline-flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\r\n              >\r\n                <Plus className=\"h-4 w-4\" />\r\n                <span>Create Project</span>\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {/* Share Modal */}\r\n      {selectedProject && (\r\n        <ProjectShareModal\r\n          isOpen={shareModalOpen}\r\n          onClose={handleCloseShareModal}\r\n          projectId={selectedProject.id}\r\n          projectName={selectedProject.name}\r\n          onShareSuccess={handleShareSuccess}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// === ProjectCard ===\r\ninterface ProjectCardProps {\r\n  project: ProjectInfo;\r\n  onClick: () => void;\r\n  onShare?: () => void;\r\n  canShare?: boolean;\r\n}\r\n\r\nfunction ProjectCard({ project, onClick, onShare, canShare = false }: ProjectCardProps) {\r\n  const handleShareClick = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    onShare?.();\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className=\"bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer\"\r\n      onClick={onClick}\r\n    >\r\n      <div className=\"flex items-start justify-between mb-2\">\r\n        <div className=\"flex-1\">\r\n          <h4 className=\"font-medium text-gray-900 truncate\">{project.name}</h4>\r\n          <span className=\"text-xs text-gray-500\">#{project.id}</span>\r\n        </div>\r\n        {canShare && onShare && (\r\n          <button\r\n            onClick={handleShareClick}\r\n            className=\"ml-2 p-1 text-gray-400 hover:text-blue-600 transition-colors\"\r\n            title=\"Share project\"\r\n          >\r\n            <Share2 className=\"h-4 w-4\" />\r\n          </button>\r\n        )}\r\n      </div>\r\n      <div className=\"flex items-center justify-between text-sm text-gray-500\">\r\n        <div className=\"flex items-center space-x-4\">\r\n          <span>{project.videoCount} videos</span>\r\n        </div>\r\n        <span className={`px-2 py-1 rounded-full text-xs ${\r\n          project.status === 'Active' ? 'bg-green-100 text-green-800' :\r\n          project.status === 'Training' ? 'bg-blue-100 text-blue-800' :\r\n          project.status === 'Complete' ? 'bg-purple-100 text-purple-800' :\r\n          'bg-gray-100 text-gray-800'\r\n        }`}>\r\n          {project.status || 'Unknown'}\r\n        </span>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1879, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jason/Nocodile/frontend/app/dashboard/page.tsx"],"sourcesContent":["\"use client\";\r\nimport React, { useEffect, useState, useCallback, memo, useRef} from \"react\";\r\nimport { Plus, Image, Video, RefreshCw, LogOut, User } from \"lucide-react\";\r\nimport \"../../css/dashboard.css\";\r\nimport Link from \"next/link\";\r\nimport { getProjectsInfo, ProjectInfo } from \"./get_project_info\";\r\nimport { getProjectDetails, type ProjectDetails } from \"./get_project_details\";\r\nimport NewProjectForm from \"./NewProjectForm\";\r\nimport UserProjectsManager from \"./UserProjectsManager\";\r\nimport { CircleDot } from \"lucide-react\";\r\nimport { log } from \"@/lib/logger\";\r\nimport { apiRequest } from \"@/lib/api-config\";\r\nimport { useProjectContext } from \"@/contexts/ProjectContext\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\n// === ProjectCard：支援即時更新 + memo 優化 ===\r\nconst ProjectCard = memo(\r\n  ({\r\n    id,\r\n    name,\r\n    videoCount,\r\n    status,\r\n    isOwned,\r\n  }: {\r\n    id: number;\r\n    name: string;\r\n    videoCount: number;\r\n    status?: string;\r\n    isOwned?: boolean;\r\n  }) => {\r\n    const [details, setDetails] = useState<ProjectDetails | null>(null);\r\n    const [isLoadingDetails, setIsLoadingDetails] = useState(false);\r\n\r\n    const loadDetails = useCallback(async () => {\r\n      if (details || isLoadingDetails) return;\r\n\r\n      setIsLoadingDetails(true);\r\n      try {\r\n        const freshDetails = await getProjectDetails(id);\r\n        if (freshDetails) {\r\n          setDetails(freshDetails);\r\n        }\r\n      } catch (error) {\r\n        log.error('PROJECT_CARD', `Failed to load details for project ${id}`, { error });\r\n      } finally {\r\n        setIsLoadingDetails(false);\r\n      }\r\n    }, [id, details]);  // ← 正確依賴\r\n\r\n    return (\r\n      <Link\r\n        className=\"project-card fade-in project-card-clickable\"\r\n        href={`/project/${id}/upload`}\r\n        onMouseEnter={loadDetails}\r\n      >\r\n        <div className=\"project-header\">\r\n          <h3 className=\"project-title\">\r\n            {details?.[\"project name\"] || name}\r\n          </h3>\r\n          <div className=\"project-id\">ID: {id}</div>\r\n\r\n          {isOwned !== undefined && (\r\n            <div\r\n              className=\"project-ownership\"\r\n              style={{\r\n                fontSize: '0.8em',\r\n                color: isOwned ? '#28a745' : '#ffc107',\r\n                marginTop: '2px'\r\n              }}\r\n            >\r\n              {isOwned ? 'Owned' : 'Shared'}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"media-stats\">\r\n          <div className=\"media-item\">\r\n            <div className=\"media-icon\"><Video className=\"icon\" /></div>\r\n            <div className=\"media-info\">\r\n              <span className=\"media-count\">\r\n                {details?.[\"video count\"] !== undefined ? details[\"video count\"] : videoCount}\r\n              </span>\r\n              <span className=\"media-label\">Videos</span>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"media-item\">\r\n            <div className=\"media-icon\"><CircleDot className=\"icon\" /></div>\r\n            <div className=\"media-info\">\r\n              <span className=\"media-count\">\r\n                {details?.[\"status\"] || status || \"—\"}\r\n              </span>\r\n              <span className=\"media-label\">Status</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </Link>\r\n    );\r\n  },\r\n  (prev, next) =>\r\n    prev.id === next.id &&\r\n    prev.name === next.name &&\r\n    prev.videoCount === next.videoCount &&\r\n    prev.status === next.status &&\r\n    prev.isOwned === next.isOwned\r\n);\r\n\r\n// === Dashboard 主頁面 ===\r\nexport default function Dashboard() {\r\n  const router = useRouter();\r\n  const [projects, setProjects] = useState<ProjectInfo[]>([]);\r\n  const [isNewProjectFormOpen, setIsNewProjectFormOpen] = useState(false);\r\n  const [userId, setUserId] = useState<number>(-1);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [apiError, setApiError] = useState<string | null>(null);\r\n  const [username, setUsername] = useState<string>(\"\");\r\n  const [isLoggingOut, setIsLoggingOut] = useState(false);\r\n  const [lastUpdateTime, setLastUpdateTime] = useState<Date | null>(null);\r\n  const { projects: contextProjects, updateProject, isLoading: contextLoading, error: contextError } = useProjectContext();\r\n  const lastLoadTimeRef = useRef<number>(0); // 記錄上次成功載入時間\r\n  const isLoadingRef = useRef(false); // 防止重複 loading\r\n  const stableUpdateProject = useCallback(updateProject, []); // 穩定化的 updateProject\r\n\r\n  // === 獲取用戶資訊 ===\r\n  useEffect(() => {\r\n    const getUserInfo = async () => {\r\n      if (typeof window !== 'undefined' && window.cookieStore) {\r\n        try {\r\n          const userIdCookie = await window.cookieStore.get(\"userId\");\r\n          const usernameCookie = await window.cookieStore.get(\"username\");\r\n          if (userIdCookie?.value) setUserId(parseInt(userIdCookie.value));\r\n          if (usernameCookie?.value) setUsername(usernameCookie.value);\r\n        } catch (error) {\r\n          log.error('DASHBOARD', 'Error getting user info from cookies', { error });\r\n        }\r\n      }\r\n    };\r\n    getUserInfo();\r\n  }, []);\r\n  const now = Date.now(); // 加上這行！\r\n  // === 完整節流載入函數 ===\r\n  const loadProjectsWithThrottle = useCallback(async () => {\r\n    // 步驟1：防止重複 loading\r\n    if (isLoadingRef.current) {\r\n      log.warn('DASHBOARD', 'Load already in progress, skipping');\r\n      return;\r\n    }\r\n\r\n    // 步驟3：開始 loading\r\n    isLoadingRef.current = true;\r\n    setIsLoading(true);\r\n    setApiError(null);\r\n\r\n    try {\r\n      if (userId <= 0) throw new Error('Invalid userId');\r\n\r\n      const apiProjects = await getProjectsInfo(userId);\r\n\r\n      // 更新 context\r\n      apiProjects.forEach(project => {\r\n        updateProject(project.id.toString(), {\r\n          id: project.id.toString(),\r\n          name: project.name,\r\n          videoCount: project.videoCount,\r\n          status: project.status || 'Active'\r\n        });\r\n      });\r\n\r\n    setProjects(apiProjects);\r\n    lastLoadTimeRef.current = now;\r\n    setLastUpdateTime(new Date());\r\n\r\n  } catch (error) {\r\n    const msg = error instanceof Error ? error.message : 'Unknown error';\r\n    setApiError(`Failed to load projects: ${msg}`);\r\n  } finally {\r\n    isLoadingRef.current = false;\r\n    setIsLoading(false); // 關鍵：UI 也要關\r\n  }\r\n}, [userId, stableUpdateProject]);\r\n\r\n  // === 登出功能 ===\r\n  const handleLogout = async () => {\r\n    setIsLoggingOut(true);\r\n    try {\r\n      await apiRequest('/logout', { method: 'POST' });\r\n    } catch (error) {\r\n      log.error('DASHBOARD', 'Error during logout', { error });\r\n    }\r\n    if (typeof window !== 'undefined' && window.cookieStore) {\r\n      await window.cookieStore.delete(\"userId\");\r\n      await window.cookieStore.delete(\"username\");\r\n    }\r\n    router.push(\"/\");\r\n  };\r\n\r\n  // === 初始載入 ===\r\n  useEffect(() => {\r\n    if (userId > 0) {\r\n      loadProjectsWithThrottle();\r\n    }\r\n  }, [userId, loadProjectsWithThrottle]);\r\n\r\nconst resetLoading = useCallback(() => {\r\n  isLoadingRef.current = false;     // 重開閘門\r\n  setIsLoading(false); \r\n  setProjects([]);         // 清空舊資料\r\n  loadProjectsWithThrottle();     // 真正重新載入 API\r\n}, [loadProjectsWithThrottle]);\r\n  // === 手動刷新按鈕 ===\r\n  return (\r\n    <div className=\"dashboard-container\">\r\n      {/* Header */}\r\n      <header className=\"dashboard-header\">\r\n        <div className=\"header-content\">\r\n          <div className=\"header-flex\">\r\n            <div className=\"flex items-center\">\r\n              <h1 className=\"header-title\">My Projects</h1>\r\n            </div>\r\n            <div className=\"header-actions\">\r\n              {username && (\r\n                <div className=\"flex items-center gap-2 mr-4 text-sm text-gray-600\">\r\n                  <User className=\"w-4 h-4\" />\r\n                  <span>Welcome, {username}</span>\r\n                </div>\r\n              )}\r\n              <button\r\n                className=\"btn-secondary flex items-center gap-2 mr-2\"\r\n                onClick={resetLoading}\r\n                disabled={isLoading}\r\n                title=\"Refresh projects manally\"\r\n              >\r\n                <RefreshCw className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />\r\n                <span>{isLoading ? 'Refreshing...' : 'Refresh'}</span>\r\n              </button>\r\n              <button\r\n                className=\"btn-secondary flex items-center gap-2 mr-2\"\r\n                onClick={handleLogout}\r\n                disabled={isLoggingOut}\r\n              >\r\n                <LogOut className={`w-4 h-4 ${isLoggingOut ? 'animate-spin' : ''}`} />\r\n                <span>{isLoggingOut ? 'Logging out...' : 'Logout'}</span>\r\n              </button>\r\n              <button\r\n                className=\"btn-primary\"\r\n                onClick={() => setIsNewProjectFormOpen(true)}\r\n              >\r\n                <Plus />\r\n                <span>New Project</span>\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </header>\r\n    <main className=\"dashboard-main\">\r\n\r\n      <div className=\"dashboard-content\">\r\n\r\n        {/* 共享專案區塊（如果有 userId 才顯示） */}\r\n        {userId > 0 && username && (\r\n          <section> \r\n            <h2 className=\"text-xl font-semibold mb-4\">Shared with Me</h2>  {/* h2: 明顯標題 */}\r\n            <UserProjectsManager\r\n              userId={userId}\r\n              username={username}\r\n              onProjectClick={(projectId) => {\r\n                window.location.href = `/project/${projectId}/upload`;\r\n              }}\r\n              onCreateProject={() => setIsNewProjectFormOpen(true)}\r\n            />\r\n          </section>\r\n        )}\r\n      </div>\r\n    </main>\r\n\r\n      {/* New Project Modal */}\r\n      <NewProjectForm\r\n        isOpen={isNewProjectFormOpen}\r\n        onClose={() => setIsNewProjectFormOpen(false)}\r\n        userId={userId}\r\n        onProjectCreated={(newProject) => {\r\n          setProjects((prev) => [\r\n            { ...newProject, status: (newProject as any).status ?? \"Not started\" },\r\n            ...prev,\r\n          ]);\r\n        }}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}